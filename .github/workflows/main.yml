
name: Cardmarket Export to Branch
on:
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sundays
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start Date (YYYY-MM-DD)'
        required: false
      end_date:
        description: 'End Date (YYYY-MM-DD)'
        required: false
      year:
        description: 'Specific Year (e.g. 2025)'
        required: false

permissions:
  contents: write

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install chromium

      - name: Run Export Script
        env:
          CM_USERNAME: ${{ secrets.CM_USERNAME }}
          CM_PASSWORD: ${{ secrets.CM_PASSWORD }}
        run: |
          python export_script.py \
            ${{ github.event.inputs.start_date && format('--start-date {0}', github.event.inputs.start_date) || '' }} \
            ${{ github.event.inputs.end_date && format('--end-date {0}', github.event.inputs.end_date) || '' }} \
            ${{ github.event.inputs.year && format('--year {0}', github.event.inputs.year) || '' }}

      - name: Commit and Push to exports branch
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create or switch to exports branch
          if git show-ref --verify --quiet refs/remotes/origin/exports; then
            git checkout exports
            git pull origin exports
          else
            git checkout -b exports
          fi
          
          # Move file from main to here if needed (it should be in root)
          git add cardmarket_export.csv
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes in CSV, skipping commit."
          else
            git commit -m "Update Cardmarket Export: $(date +'%Y-%m-%d %H:%M')"
            git push origin exports
          fi
